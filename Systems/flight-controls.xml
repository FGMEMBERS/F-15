<system  name="FCS F15">
<!-- F-15 Flight controls 
   |  Richard Harrison: 2014-11-23 : rjh@zaretto.com - based on F-14 
   Longitudinal travel: -10 to 15cm
-->
	<property value="1">gear/serviceable</property>
	<property value="0">systems/hydraulics/emerg-gear-bleed</property>
	<property value="0">gear/damage-reset</property>
	<property value="2">position/aircraft-on-ground-last-value</property>
	<property value="0">systems/cadc/pitch-ratio-emergency</property>
	<property value="0">systems/cadc/roll-ratio-emergency</property>
	
	<!--A Comparison of Control Allocation Methods for the F-15 ACTIVE Research Aircraft Utilizing Real-Time Piloted Simulations
		Kevin R. Scalera
		Table 2.1: Control surface limits
		Control Effector Deflection (deg) Rate Limit (deg/s)
			DHT(L/R) -29.0 / 15.0 ±46
			DAIL(L/R) -20.0 / 20.0 ±100
			DRUD(L/R) -30.0 / 30.0 ±105
			FLAPS(L/R) 0.0 / 35.0 ±18
	-->
	
	<!-- Begin Flight Control System by Joshua Davidson (it0uchpods) -->
	
	<channel name="Common">
		
		<switch name="fcs/stick-pitch">
			<default value="0"/>
			<test value="fcs/elevator-cmd-norm">
				autoflight/input/pitch-switch ne 1
			</test>
		</switch>
		
		<switch name="fcs/css-pitch">
			<default value="0"/>
			<test logic="AND" value="autoflight/ss/elevator-norm">
				autoflight/input/pitch-switch eq 1
				autoflight/ss/elevator-norm ne 0
			</test>
		</switch>
		
		<switch name="fcs/stick-roll">
			<default value="0"/>
			<test value="fcs/aileron-cmd-norm">
				autoflight/input/roll-switch ne 1
			</test>
		</switch>

		<switch name="fcs/css-roll">
			<default value="0"/>
			<test logic="AND" value="autoflight/ss/aileron-norm">
				autoflight/input/roll-switch eq 1
				autoflight/ss/aileron-norm ne 0
			</test>
		</switch>
	
	</channel>
	
	<channel name="Elevons">
		
		<fcs_function name="fcs/pitch-trim-compensation">
			<function>
				<table>
					<independentVar lookup="row">velocities/vc-kts</independentVar>
					<independentVar lookup="column">fcs/flap-pos-deg</independentVar>
					<tableData>
						     0         35
						  0 -0.288600 -0.122750
						200 -0.188860 -0.102750
						310 -0.061875  0.022125
						415 -0.037920  0.076125
						520  0.020500  0.076125
						620  0.001877  0.076125
						740  0.134250  0.076125
						820  0.174000  0.076125
						900  0.216250  0.076125
					</tableData>
				</table>
			</function>
		</fcs_function>
		
		<summer name="fcs/pitch-input-sum">
			<input>fcs/stick-pitch</input> <!-- Stick Input with A/P off -->
			<input>fcs/css-pitch</input> <!-- Stick Input in CSS A/P mode -->
			<input>fcs/pitch-trim-cmd-norm</input> <!-- Pitch Trim -->
			<input>autoflight/pitch/pitch-rate-demand</input> <!-- A/P Pitch Demand -->
			<input>fcs/pitch-trim-compensation</input> <!-- Pitch Trim Compensation -->
			<input>cas/pitch-output</input> <!-- CAS Pitch Command -->
			<clipto>
				<min>-1.0</min>
				<max>0.51724</max>
			</clipto>
		</summer>
		
		<fcs_function name="fcs/pitch-ratio-calc"> <!-- Guesses, I found no data -->
			<function>
				<table>
					<independentVar lookup="row">velocities/mach</independentVar>
					<independentVar lookup="column">atmosphere/density-altitude</independentVar>
					<tableData> <!-- Low and ultra high mach excluded, as the manual shows, they differ from the standard -->
							  0      15000  30000  45000  65000
						0.50  1.000  1.000  1.000  1.000  1.000
						0.70  0.450  0.590  1.000  1.000  1.000
						0.80  0.340  0.425  1.000  1.000  1.000
						0.90  0.230  0.260  0.340  1.000  1.000
						1.00  0.182  0.214  0.285  0.875  1.000
						1.10  0.135  0.168  0.230  0.360  1.000
						1.20  0.125  0.155  0.217  0.342  1.000
						1.30  0.115  0.141  0.204  0.324  0.804
						1.50  0.104  0.122  0.178  0.275  0.513
						1.75  0.097  0.112  0.166  0.260  0.490
						2.00  0.092  0.102  0.152  0.250  0.423
						2.25  0.085  0.094  0.138  0.225  0.400
						2.50  0.084  0.089  0.130  0.200  0.381
					</tableData>
				</table>
			</function>
			<clipto>
				<min>0.01</min>
				<max>1.0</max>
			</clipto>
		</fcs_function>
		
		<switch name="fcs/pitch-ratio">
			<default value="fcs/pitch-ratio-calc"/>
			<test logic="OR" value="0.5">
				systems/hydraulics/flight-system-pressure ne 1
				systems/cadc/pitch-ratio-emergency ne 0
			</test>
		</switch>
		
		<pure_gain name="fcs/pitch-ratio-input">
			<input>fcs/pitch-input-sum</input>
			<gain>fcs/pitch-ratio</gain>
		</pure_gain>
		
		<pure_gain name="fcs/pitch-input-deg">
			<input>fcs/pitch-ratio-input</input>
			<gain>29.0</gain>
			<clipto>
				<min>-29.0</min>
				<max>15.0</max>
			</clipto>
		</pure_gain>
		
		<summer name="fcs/roll-elevon-input-sum">
			<input>fcs/stick-roll</input> <!-- Stick Input with A/P off -->
			<input>fcs/css-roll</input> <!-- Stick Input in CSS A/P mode -->
			<input>fcs/roll-trim-cmd-norm</input> <!-- Roll Trim -->
			<input>autoflight/roll/roll-rate-demand</input> <!-- A/P Roll Demand -->
			<input>cas/roll-output</input> <!-- CAS Roll Command -->
			<clipto>
				<min>-1.0</min>
				<max>1.0</max>
			</clipto>
		</summer>
		
		<fcs_function name="fcs/roll-ratio-calc"> <!-- Guesses, I found no data -->
			<function>
				<table>
					<independentVar lookup="row">velocities/mach</independentVar>
					<independentVar lookup="column">atmosphere/density-altitude</independentVar>
					<tableData>
							  0      15000  30000  45000  65000
						0.15  1.000  1.000  1.000  1.000  1.000
						0.25  0.541  0.617  0.650  0.739  0.779
						0.30  0.501  0.547  0.596  0.652  0.694
						0.50  0.311  0.364  0.379  0.421  0.426
						0.70  0.210  0.244  0.292  0.314  0.338
						0.90  0.151  0.167  0.200  0.255  0.283
						1.10  0.123  0.128  0.140  0.167  0.251
						1.30  0.104  0.108  0.116  0.129  0.197
						1.50  0.091  0.096  0.100  0.108  0.156
						1.75  0.080  0.083  0.085  0.091  0.117
						2.00  0.069  0.072  0.076  0.079  0.094
						2.25  0.060  0.064  0.067  0.070  0.076
						2.50  0.054  0.056  0.061  0.064  0.071
						2.75  0.050  0.053  0.056  0.058  0.066
					</tableData>
				</table>
			</function>
			<clipto>
				<min>0.01</min>
				<max>1.0</max>
			</clipto>
		</fcs_function>
		
		<switch name="fcs/roll-ratio">
			<default value="fcs/roll-ratio-calc"/>
			<test logic="OR" value="0.5">
				systems/cadc/roll-ratio-emergency ne 0
				systems/hydraulics/flight-system-pressure ne 1
			</test>
		</switch>
		
		<fcs_function name="fcs/roll-elevon-input-deg">
			<description>
				http://www.f15sim.com/operation/f15_lat_control.html
				Figure 4 Mechanmical lateral control authority.
					** iv; Vc Kts
					** stabilator maximum
					** dv: full stock aileron deflection degrees
			</description>
			<function>
				<product>
					<property>fcs/roll-elevon-input-sum</property>
					<value>9.66666667</value> <!-- Maximum Roll Authority, 29 degrees * 0.3 -->
					<property>fcs/roll-ratio</property>
					<table>
						<independentVar lookup="row">fcs/pitch-input-deg</independentVar>
						<independentVar lookup="column">velocities/vc-kts</independentVar>
						<tableData>
							     635.0 664.3 668.2 714.8 741.3 768.0 794.7
							-24  0.16  0.16  0.16  0.16  0.16  0.16  0.16
							-23  0.16  0.16  0.16  0.16  0.16  0.16  0.16
							-22  0.16  0.16  0.16  0.16  0.16  0.15  0.16
							-21  0.16  0.16  0.16  0.16  0.16  0.15  0.16
							-20  0.16  0.16  0.16  0.16  0.16  0.15  0.16
							-19  0.16  0.16  0.16  0.16  0.16  0.15  0.16
							-18  0.19  0.19  0.20  0.20  0.19  0.19  0.19
							-17  0.29  0.30  0.30  0.30  0.30  0.29  0.24
							-16  0.39  0.40  0.40  0.40  0.40  0.38  0.24
							-15  0.50  0.50  0.51  0.50  0.50  0.38  0.24
							-14  0.60  0.60  0.61  0.61  0.50  0.38  0.24
							-13  0.70  0.70  0.71  0.63  0.50  0.38  0.24
							-12  0.80  0.81  0.75  0.63  0.50  0.38  0.24
							-11  0.91  0.87  0.75  0.63  0.50  0.38  0.25
							-10  1.00  0.87  0.75  0.63  0.50  0.38  0.25
							 -9  1.00  0.87  0.75  0.63  0.50  0.38  0.25
							 -8  1.00  0.87  0.75  0.63  0.50  0.38  0.25
							 -7  1.00  0.88  0.75  0.63  0.50  0.38  0.25
							 -6  1.00  0.88  0.75  0.63  0.50  0.38  0.25
							 -5  1.00  0.88  0.75  0.63  0.50  0.38  0.25
							 -4  0.90  0.88  0.75  0.63  0.50  0.38  0.25
							 -3  0.79  0.80  0.75  0.63  0.50  0.38  0.25
							 -2  0.69  0.69  0.69  0.63  0.50  0.38  0.25
							 -1  0.58  0.59  0.59  0.59  0.50  0.38  0.25
							  0  0.47  0.49  0.48  0.49  0.48  0.38  0.25
							  1  0.37  0.39  0.38  0.40  0.38  0.38  0.25
							  2  0.26  0.28  0.27  0.30  0.28  0.28  0.25
							  3  0.25  0.25  0.24  0.25  0.25  0.24  0.25
							  4  0.25  0.25  0.24  0.25  0.24  0.24  0.25
							  5  0.25  0.25  0.24  0.25  0.24  0.24  0.25
							  6  0.24  0.25  0.24  0.25  0.24  0.24  0.25
							  7  0.24  0.25  0.24  0.25  0.24  0.24  0.25
							  8  0.24  0.25  0.24  0.25  0.24  0.24  0.25
							  9  0.24  0.25  0.24  0.25  0.24  0.24  0.25
							 10  0.24  0.25  0.24  0.25  0.24  0.24  0.25
							 11  0.24  0.25  0.24  0.25  0.24  0.24  0.25
							 12  0.24  0.24  0.24  0.24  0.24  0.24  0.25
							 13  0.24  0.24  0.24  0.24  0.24  0.24  0.25
							 14  0.24  0.24  0.24  0.24  0.24  0.24  0.25
							 15  0.24  0.24  0.24  0.24  0.24  0.24  0.24
							 16  0.24  0.24  0.24  0.24  0.24  0.24  0.24
						</tableData>
					</table>
				</product>
			</function>
		</fcs_function>
		
		<summer name="fcs/elevon-left-cmd">
			<input>fcs/pitch-input-deg</input>
			<input>fcs/roll-elevon-input-deg</input>
			<clipto>
				<min>-29.0</min>
				<max>15.0</max>
			</clipto>
		</summer>
		
		<actuator name="fcs/elevon-left">
			<input>fcs/elevon-left-cmd</input>
			<rate_limit>1334</rate_limit> <!-- 46 * 29 degrees -->
			<lag>26.7</lag>
		</actuator>
		
		<aerosurface_scale name="fcs/elevon-left-norm">
			<input>fcs/elevon-left</input>
			<domain>
				<min>-29.0</min>
				<max>29.0</max>
			</domain>
			<range>
				<min>-1.0</min>
				<max>1.0</max>
			</range>
			<output>/sim/multiplay/generic/float[4]</output>
		</aerosurface_scale>
		
		<summer name="fcs/elevon-right-cmd">
			<input>fcs/pitch-input-deg</input>
			<input>-fcs/roll-elevon-input-deg</input>
			<clipto>
				<min>-29.0</min>
				<max>15.0</max>
			</clipto>
		</summer>
		
		<actuator name="fcs/elevon-right">
			<input>fcs/elevon-right-cmd</input>
			<rate_limit>1334</rate_limit> <!-- 46 * 29 degrees -->
			<lag>26.7</lag>
		</actuator>
		
		<aerosurface_scale name="fcs/elevon-right-norm">
			<input>fcs/elevon-right</input>
			<domain>
				<min>-29.0</min>
				<max>29.0</max>
			</domain>
			<range>
				<min>-1.0</min>
				<max>1.0</max>
			</range>
			<output>/sim/multiplay/generic/float[5]</output>
		</aerosurface_scale>
		
		<fcs_function name="fcs/elevon-diff-aero-deg">
			<function>
				<sum>
					<property>fcs/elevon-left</property>
					<product>
						<property>fcs/elevon-right</property>
						<value>-1.0</value>
					</product>
				</sum>
			</function>
		</fcs_function>
		
		<fcs_function name="fcs/elevon-aero-deg">
			<function>
				<sum>
					<product>
						<property>fcs/elevon-left</property>
						<value>0.5</value>
					</product>
					<product>
						<property>fcs/elevon-right</property>
						<value>0.5</value>
					</product>
				</sum>
			</function>
		</fcs_function>
	
	</channel>
	
	<channel name="Ailerons">
		
		<summer name="fcs/roll-aileron-input-sum">
			<input>fcs/stick-roll</input> <!-- Stick Input with A/P off -->
			<input>fcs/css-roll</input> <!-- Stick Input in CSS A/P mode -->
			<input>fcs/roll-trim-cmd-norm</input> <!-- Roll Trim -->
			<input>autoflight/roll/roll-rate-demand</input> <!-- A/P Roll Demand -->
			<clipto>
				<min>-1.0</min>
				<max>1.0</max>
			</clipto>
		</summer>
		
		<pure_gain name="fcs/roll-aileron-ratio-input">
			<input>fcs/roll-aileron-input-sum</input>
			<gain>fcs/roll-ratio</gain>
		</pure_gain>
		
		<pure_gain name="fcs/aileron-input-deg">
			<input>fcs/roll-aileron-ratio-input</input>
			<gain>20.0</gain>
		</pure_gain>
		
		<actuator name="fcs/aileron-left">
			<input>fcs/aileron-input-deg</input>
			<rate_limit>2000</rate_limit> <!-- 100 * 20 degrees -->
			<lag>26.7</lag>
		</actuator>
		
		<aerosurface_scale name="fcs/aileron-left-norm">
			<input>fcs/aileron-left</input>
			<domain>
				<min>-20.0</min>
				<max>20.0</max>
			</domain>
			<range>
				<min>-1.0</min>
				<max>1.0</max>
			</range>
			<output>/sim/multiplay/generic/float[2]</output>
		</aerosurface_scale>
		
		<actuator name="fcs/aileron-right">
			<input>-fcs/aileron-input-deg</input>
			<rate_limit>2000</rate_limit> <!-- 100 * 20 degrees -->
			<lag>26.7</lag>
			<output>/sim/multiplay/generic/float[3]</output>
		</actuator>
		
		<aerosurface_scale name="fcs/aileron-right-norm">
			<input>fcs/aileron-right</input>
			<domain>
				<min>-20.0</min>
				<max>20.0</max>
			</domain>
			<range>
				<min>-1.0</min>
				<max>1.0</max>
			</range>
			<output>/sim/multiplay/generic/float[3]</output>
		</aerosurface_scale>
		
		<fcs_function name="fcs/aileron-aero-deg">
			<function>
				<sum>
					<product>
						<property>fcs/aileron-left</property>
						<value>0.5</value>
					</product>
					<product>
						<property>fcs/aileron-right</property>
						<value>-0.5</value>
					</product>
				</sum>
			</function>
		</fcs_function>
	
	</channel>
	
	<channel name="Yaw">
		
		<switch name="fcs/ari-mach-switch"> <!-- Prevents switch from rapidly going back and forth -->
			<default value="fcs/ari-mach-switch"/>
			<test value="1">
				velocities/mach le 0.9925
			</test>
			<test value="0">
				velocities/mach ge 1.0075
			</test>
		</switch>
		
		<switch name="fcs/ari-lateral-enabled">
			<default value="0"/>
			<test logic="AND" value="1">
				position/aircraft-on-ground eq 0
				autoflight/output/roll-master ne 1
				systems/hydraulics/flight-system-pressure eq 1
				fcs/ari-mach-switch eq 1
				cas/yaw-cas-active ne 1
			</test>
		</switch>
		
		<pure_gain name="fcs/ari-aileron-input">
			<input>fcs/aileron-cmd-norm</input>
			<gain>fcs/roll-ratio</gain>
		</pure_gain>
		
		<fcs_function name="fcs/rudder-ari">
			<description>
				This is the amount of rudder per inch of lateral stick. NASA-TM-72861, Figure 23
				The tables have been normalized to remove the inches of stick movement, based on my understanding that there is about 4inches of stick deflection.
			</description>
			<function>
				<product>
					<property>fcs/ari-aileron-input</property>
					<property>fcs/ari-lateral-enabled</property>
					<table>
						<independentVar lookup="row">fcs/elevon-aero-deg</independentVar>
						<independentVar lookup="column">fcs/flap-pos-deg</independentVar>
						<tableData>
							     0      30
							-24 -0.923 -0.818
							  0 -0.105  0.000
							 15  0.406  0.511
						</tableData>
					</table>
				</product>
			</function>
			<output>cas/ari-input</output>
			<clipto>
				<min>-1.0</min>
				<max>1.0</max>
			</clipto>
		</fcs_function>
		
		<switch name="fcs/rudder-gain"> <!-- Prevents gain from rapidly going back and forth -->
			<default value="fcs/rudder-gain"/>
			<test value="0.5"> <!-- 15 degrees -->
				velocities/mach le 1.4925
			</test>
			<test value="0.166666666"> <!-- 5 degrees -->
				velocities/mach ge 1.5075
			</test>
		</switch>
		
		<fcs_function name="fcs/rudder-input-limited">
			<function>
				<product>
					<sum>
						<property>fcs/rudder-cmd-norm</property>
						<property>fcs/yaw-trim-cmd-norm</property>
					</sum>
					<property>fcs/rudder-gain</property>
				</product>
			</function>
		</fcs_function>
		
		<summer name="fcs/yaw-input-sum">
			<input>fcs/rudder-input-limited</input> <!-- Rudder and Rudder Trim limited -->
			<input>fcs/rudder-ari</input> <!-- Non CAS ARI -->
			<input>-cas/yaw-output</input> <!-- CAS Yaw Command -->
			<clipto>
				<min>-1.0</min>
				<max>1.0</max>
			</clipto>
		</summer>
		
		<pure_gain name="fcs/rudder-input-deg">
			<input>fcs/yaw-input-sum</input>
			<gain>30.0</gain>
			<clipto>
				<min>-30.0</min>
				<max>30.0</max>
			</clipto>
		</pure_gain>
		
		<actuator name="fcs/rudder-aero-deg">
			<input>fcs/rudder-input-deg</input>
			<rate_limit>3150</rate_limit> <!-- 105 * 30 degrees -->
			<lag>22.7</lag>
			<output>/sim/multiplay/generic/float[1]</output>
		</actuator>
		
		<aerosurface_scale name="fcs/rudder-aero-norm">
			<input>fcs/rudder-aero-deg</input>
			<domain>
				<min>-30.0</min>
				<max>30.0</max>
			</domain>
			<range>
				<min>-1.0</min>
				<max>1.0</max>
			</range>
			<output>/sim/multiplay/generic/float[1]</output>
		</aerosurface_scale>
	
	</channel>
	
	<!-- End Flight Control System by Joshua Davidson (it0uchpods) -->

    <channel name="Flaps">
        <switch name="fcs/flap-total-dmd">
            <default value="0"/>
            <test value="fcs/flap-total-dmd">
                systems/hydraulics/combined-system-pressure ne 1
            </test>
            <test value="fcs/flap-cmd-norm">
                fcs/flap-cmd-norm ne 0
                systems/hydraulics/combined-system-pressure ne 0
            </test>
            <clipto>
                <min> 0 </min>
                <max>  1 </max>
            </clipto>
            <output>fcs/flap-total-dmd</output>
        </switch>

        <kinematic name="Flaps Control">
            <input>fcs/flap-total-dmd</input>
            <traverse>
                <setting>
                    <position>  0 </position>
                    <time>      0 </time>
                </setting>
                <setting>
                    <position> 30 </position>
                    <time>    1.944</time>
                </setting>
            </traverse>
            <output>fcs/flap-pos-deg</output>
        </kinematic>

        <aerosurface_scale name="flap normalization">
            <input>fcs/flap-pos-deg</input>
            <domain>
                <min>  0 </min>
                <max> 30 </max>
            </domain>
            <range>
                <min> 0 </min>
                <max> 1 </max>
            </range>
            <output>fcs/flap-pos-norm</output>
        </aerosurface_scale>


    </channel>

    <channel name="Landing Gear">
<!-- landing gear;
1. Switch up down
2. emergency handle

- normal operation (emergency handle retracted).
  : requires hyds
  : cannot retract on ground
  
  parts:
    uplock
    downlock
    door
    bogeys
    
    uplock downlock modelled as single lock -ve for downlock 0 for unlocked, 1 for uplocked
    
emerg operation.
: handle pulled. hyds & electrics cut
-->
        <!--<pure_gain name="gear/unit[0]/pos-norm">
            <description>Landing gear unit 0 position</description>
            <input>gear/gear-pos-norm</input>
            <gain> 1</gain>
        </pure_gain>
        <pure_gain name="gear/unit[1]/pos-norm">
            <description>Landing gear unit 0 position</description>
            <input>gear/gear-pos-norm</input>
            <gain> 1</gain>
        </pure_gain>
        <pure_gain name="gear/unit[2]/pos-norm">
            <description>Landing gear unit 0 position</description>
            <input>gear/gear-pos-norm</input>
            <gain> 1</gain>
        </pure_gain>-->

        <!-- Deplete the JFS store-->
        <switch name="systems/hydraulics/emerg-gear-unlocked">
            <default value="0"/>
            <test value="1">
                systems/hydraulics/util-system-accumulator-psi gt 200
                gear/emergency-handle gt 0.7
                gear/unit[0]/locked ne 0
            </test>
            <test value="systems/hydraulics/emerg-gear-unlocked">
                gear/emergency-handle gt 0.7
            </test>            
        </switch>
        <switch name="systems/hydraulics/emerg-gear-bleed">
            <default value="0"/>
            <test value="10000">
                systems/hydraulics/emerg-gear-unlocked ne 0
                gear/unit[0]/locked ne 0
            </test>
        </switch>

        <switch name="gear/unit[0]/locked">
            <default value="-1"/>
            <test value="0">
                systems/hydraulics/emerg-gear-unlocked ne 0
                <!-- unlocked when handle pulled -->
                gear/emergency-handle gt 0.7
                gear/emerg-pos lt 1
            </test>
            <test value="0">
                <!-- unlocked. -->
               gear/gear-pos-norm gt 0
               gear/gear-pos-norm lt 1
            </test>
            <test value="1">
               gear/gear-pos-norm le 0
            </test>
            <test value="-1">
               gear/gear-pos-norm ge 1
            </test>
        </switch>
        <switch name="gear/unit[1]/locked">
            <default value="-1"/>
            <test value="0">
                <!-- unlocked when handle pulled -->
                <!-- should deplete the JFS store-->
                gear/emergency-handle gt 0.7
                gear/emerg-pos lt 1
            </test>
            <test value="0">
                <!-- unlocked. -->
               gear/gear-pos-norm gt 0
               gear/gear-pos-norm lt 1
            </test>
            <test value="1">
               gear/gear-pos-norm le 0
            </test>
            <test value="-1">
               gear/gear-pos-norm ge 1
            </test>
        </switch>
        <switch name="gear/unit[2]/locked">
            <default value="-1"/>
            <test value="0">
                <!-- unlocked when handle pulled -->
                <!-- should deplete the JFS store-->
                gear/emergency-handle gt 0.7
                gear/emerg-pos lt 1
            </test>
            <test value="0">
                <!-- unlocked. -->
               gear/gear-pos-norm gt 0
               gear/gear-pos-norm lt 1
            </test>
            <test value="1">
               gear/gear-pos-norm le 0
            </test>
            <test value="-1">
               gear/gear-pos-norm ge 1
            </test>
        </switch>
        <switch name="gear/emerg-pos">
            <default value="gear/emerg-pos-dmd"/>
        </switch>
        <fcs_function name="gear/emerg-pos-dmd">
            <function>
                <ifthen>
                    <and>
                        <ge>
                            <property>gear/emergency-handle</property>
                            <value>0.9</value>
                        </ge>
                        <or>
                            <eq>
                                <property>gear/unit[0]/locked</property>
                                <value>-1.0</value>
                            </eq>
                            <and>
                                <eq>
                                    <property>contact/unit[9]/WOW</property>
                                    <value>0</value>
                                </eq>
                                <eq>
                                    <property>contact/unit[10]/WOW</property>
                                    <value>0</value>
                                </eq>
                            </and>
                        </or>
                    </and>
                    <sum>
                        <property>gear/emerg-pos</property>
                        <ifthen><not><eq><property>gear/unit[0]/locked</property><value>1.0</value></eq></not>
                            <table>
                                <independentVar lookup="row">gear/emerg-pos</independentVar>
                                <independentVar lookup="column">accelerations/Nz</independentVar>
                                <tableData>
                                               -3.0     0.0     0.5     1.0     1.2     2.0     5.0    10.0
                                   -0.00001  0.00000 0.00100 0.00000 0.00090 0.00090 0.00090 0.00090 0.00400
                                    0.0     -0.00400 0.00000 0.00000 0.00090 0.00090 0.00090 0.00090 0.00400
                                    0.90     0.00000 0.00000 0.00000 0.00090 0.00090 0.00090 0.00090 0.00400
                                    0.98     0.11000 0.00000 0.00000 0.00000 0.00000 0.09000 0.11090 0.00400
                                    1.0      0.00000 0.00000 0.00000 0.00090 0.00090 0.00090 0.00090 0.00400
                                </tableData>
                            </table>
                            <value>0</value>
                    </ifthen>
                    </sum>
                    <value>0</value>
                </ifthen>
            </function>
        </fcs_function>

        <switch name="gear/unit[0]/damaged">
            <default value="gear/unit[0]/damaged"/>
            <test logic="AND" value="0">
                gear/damage-reset ne 0
            </test>
                <test logic="AND" value="1">
                position/aircraft-on-ground ne 0
                position/aircraft-on-ground-last-value ne position/aircraft-on-ground
                velocities/h-dot-fps le -20
                gear/unit[0]/WOW ne 0
            </test>
        </switch>
        <switch name="gear/unit[1]/damaged">
            <default value="gear/unit[1]/damaged"/>
            <test logic="AND" value="0">
                gear/damage-reset ne 0
            </test>
            <test logic="AND" value="1">
                position/aircraft-on-ground ne 0
                position/aircraft-on-ground-last-value ne position/aircraft-on-ground
                velocities/h-dot-fps le -20
                gear/unit[1]/WOW ne 0
            </test>
        </switch>
        <switch name="gear/unit[2]/damaged">
            <default value="gear/unit[2]/damaged"/>
            <test logic="AND" value="0">
                gear/damage-reset ne 0
            </test>
            <test logic="AND" value="1">
                position/aircraft-on-ground ne 0
                position/aircraft-on-ground-last-value ne position/aircraft-on-ground
                velocities/h-dot-fps le -20
                gear/unit[2]/WOW ne 0
            </test>
        </switch>
        <switch name="Gear Unit 0 Z">
            <default value="-77.6496063"/>
            <test value="-20">
                gear/unit[0]/damaged eq 1
            </test>
            <output>gear/unit[0]/z-position</output>
        </switch>
        <switch name="Gear Unit 1 Z">
            <default value="-84.3385827"/>
            <test value="-30">
                gear/unit[1]/damaged eq 1
            </test>
            <output>gear/unit[1]/z-position</output>
        </switch>
        <switch name="Gear Unit 2 Z">
            <default value="-84.3385827"/>
            <test value="-30">
                gear/unit[2]/damaged eq 1
            </test>
            <output>gear/unit[2]/z-position</output>
        </switch>

        <switch name="Contact Unit 3 Z nose door">
            <default value="-30.6496063"/>
            <test value="-55">
                gear/unit[0]/damaged eq 1
            </test>
            <output>contact/unit[3]/z-position</output>
        </switch>
        <switch name="Contact Unit 4 Z nose door">
            <default value="-30"/>
            <test value="-55">
                gear/unit[1]/damaged eq 1
            </test>
            <output>contact/unit[4]/z-position</output>
        </switch>
        <switch name="Contact Unit 5 Z nose door">
            <default value="-30"/>
            <test value="-55">
                gear/unit[2]/damaged eq 1
            </test>
            <output>contact/unit[5]/z-position</output>
        </switch>
        <switch name="tied/aircraft-on-ground-last-value">
            <default value="position/aircraft-on-ground"/>
            <output>position/aircraft-on-ground-last-value</output>
            <!--<test value="1">
            position/aircraft-on-ground ne 0
        </test>-->
        </switch>
        
        <!--Gear that is damaged will be shown as half retracted; which will look kind of broken. These
        three functions set the gear position based on the damage to the appropriate value-->
        <fcs_function name="tied/fcs-gear-0-pos-norm">
            <function>
                <ifthen>
                    <and>
                        <gt>
                            <p>gear/unit[0]/damaged</p>
                            <v>0</v>
                        </gt>
                        <gt>
                            <p>gear/gear-pos-norm</p>
                            <v>0.6</v>
                        </gt>
                    </and>
                    <v>0.5</v>
                    <p>gear/gear-pos-norm</p>
                </ifthen>
            </function>
            <output>gear/unit[0]/pos-norm</output>
        </fcs_function>

        <fcs_function name="tied/fcs-gear-1-pos-norm">
            <function>
                <ifthen>
                    <and>
                        <gt>
                            <p>gear/unit[1]/damaged</p>
                            <v>0</v>
                        </gt>
                        <gt>
                            <p>gear/gear-pos-norm</p>
                            <v>0.6</v>
                        </gt>
                    </and>
                    <v>0.5</v>
                    <p>gear/gear-pos-norm</p>
                </ifthen>
            </function>
            <output>gear/unit[1]/pos-norm</output>
        </fcs_function>
        
        <fcs_function name="tied/fcs-gear-2-pos-norm">
            <function>
                <ifthen>
                    <and>
                        <gt>
                            <p>gear/unit[2]/damaged</p>
                            <v>0</v>
                        </gt>
                        <gt>
                            <p>gear/gear-pos-norm</p>
                            <v>0.6</v>
                        </gt>
                    </and>
                    <v>0.5</v>
                    <p>gear/gear-pos-norm</p>
                </ifthen>
            </function>
            <output>gear/unit[2]/pos-norm</output>
        </fcs_function>
        <!--End of gear damage handling-->

        <switch name="tied/gear-dmd-norm">
            <default value="1"/>
            <test value="1">
                <!-- always force gear down when on ground - to prevent inadvertant retraction -->
              position/aircraft-on-ground ne 0
            </test>
            <test value="gear/emerg-pos">
              gear/emergency-handle ne 0
            </test>
            <test value="gear/gear-pos-norm">
                gear/serviceable ne 1
                gear/emergency-handle lt 1
            </test>
            <test value="gear/gear-dmd-norm">
                systems/hydraulics/combined-system-pressure ne 1
            </test>
            <test value="gear/gear-cmd-norm">
                systems/hydraulics/combined-system-pressure ne 0
            </test>
            <clipto>
                <min> 0 </min>
                <max>  1 </max>
            </clipto>
            <output>gear/gear-dmd-norm</output>
        </switch>

        <kinematic name="Gear Control">
            <input>gear/gear-dmd-norm</input>
            <traverse>
                <setting>
                    <position> 0 </position>
                    <time>     0 </time>
                </setting>
                <setting>
                    <position> 1 </position>
                    <time>     1.8 </time>
                </setting>
            </traverse>
            <output>gear/gear-pos-norm</output>
        </kinematic>

        <!--<kinematic name="fcs/steer-pos-deg">
            <input>fcs/steer-cmd-norm</input>
            <traverse>
                <setting>
                    <position>-35</position>
                    <time>1.1</time>
                </setting>
                <setting>
                    <position>35</position>
                    <time>1.1</time>
                </setting>
            </traverse>
            <output>fcs/steer-pos-deg</output>
        </kinematic>-->
    </channel>

    <channel name="Speedbrake">
        <switch name="fcs/speedbrake-dmd-norm">
            <default value="0"/>
            <test value="fcs/speedbrake-dmd-norm">
                systems/hydraulics/combined-system-pressure ne 1
            </test>
            <test value="fcs/speedbrake-cmd-norm">
                systems/hydraulics/combined-system-pressure ne 0
            </test>
            <clipto>
                <min> 0 </min>
                <max>  1 </max>
            </clipto>
            <output>fcs/speedbrake-dmd-norm</output>
        </switch>

        <kinematic name="Speedbrake Control">
            <input>fcs/speedbrake-dmd-norm</input>
            <traverse>
                <setting>
                    <position> 0 </position>
                    <time>     0 </time>
                </setting>
                <setting>
                    <position> 1 </position>
                    <time>     1.5 </time>
                </setting>
            </traverse>
            <output>fcs/speedbrake-pos-norm</output>
        </kinematic>
    </channel>

    <channel name="Hook">
        <kinematic name="fcs/hook-control">
            <input>fcs/hook-engage</input>
            <traverse>
                <setting>
                    <position>0</position>
                    <time>0</time>
                </setting>
                <setting>
                    <position>1</position>
                    <time>2.5</time>
                </setting>
            </traverse>
            <output>fcs/hook-pos-norm</output>
        </kinematic>
    </channel>
</system>
